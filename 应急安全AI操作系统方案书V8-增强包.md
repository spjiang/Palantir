# 应急安全AI操作系统方案书 V8（基于 V7 的技术完善与工程化增强包）

本文不重复 V7 的主体内容，只补充：**V7 在技术上仍需完善的关键工程能力**，并给出可落地的“怎么做/做到什么程度/如何验收”。  
目标是把方案从“能讲清楚”升级为“能交付、能运行、能扩展、能审计”。

---

## 0. V7 现状判断（结论）

V7 的优势在于：已经把“数据语义底座 + 智能体 + 工作流闭环”的主干讲清楚，关键对象模型、数据设计（回放/注入）、智能体约束、人审门禁、闭环指标也都覆盖。  
但从工程交付视角，仍有几类缺口：**契约与版本治理的工程细化、跨系统一致性与幂等、可观测与可靠性、安全合规、评测与回归体系、规模化装配方法**。

---

## 1. 对标 Palantir 业务线：V7 需要补齐的“平台级”能力

### 1.1 Foundry（数据语义与装配）还需补齐

- **数据产品化（Data Product）交付形态**：每个数据集/指标/对象状态应有“负责人、口径、质量、血缘、版本、消费契约、样例、验收”。
- **Schema/契约治理**：统一事件契约需要“可校验、可演进”的机制（Schema Registry + 兼容性策略）。
- **语义装配**：本体对象与事实/指标/规则/知识的装配方法需要固化为模板（多城市/多区域可复用）。

### 1.2 Gotham（任务指挥与行动）还需补齐

- **状态机与幂等**：任务/事件状态推进必须定义幂等键、重试、补偿与一致性边界。
- **证据链工程**：证据校验、证据版本、证据引用（可审计可追责）需要更“落表与落接口”。
- **跨部门路由**：责任体系与组织/岗位/值班的匹配规则需要版本化与可视化配置。

### 1.3 Apollo（持续交付与治理）还需补齐

- **策略/规则/模型/知识的发布治理**：灰度、回滚、审批、回测、变更影响分析需要形成统一“发布工单链路”。
- **回归验收机制**：必须有“回放+注入驱动”的自动化回归体系（每次变更可重复验证）。

---

## 2. 数据工程（V7 1.4/1.9.1）需要补齐的工程化细节

### 2.1 统一事件契约：从“字段建议”升级为“可校验契约”

- **补充内容**：
  - 事件契约给出 **JSON Schema**（或 Protobuf/Avro）版本号：`schema_version`。
  - 定义兼容性规则：向后兼容/向前兼容/破坏性变更流程。
  - 规定必填字段与约束（例如 `event_time` 不得为空、`object_ref.object_type` 枚举范围、单位字段必须带单位）。
- **验收**：
  - 任意接入数据通过“契约校验”才可入标准事实层。
  - 破坏性变更必须走版本升级并保留兼容期。

### 2.2 事件时间（Event Time）一致性：迟到、乱序、重复的工程策略

- **补充内容**：
  - 定义允许迟到窗口（如 10 分钟）与处理路径：正常窗/迟到修正/超迟到隔离。
  - 定义去重键（如 `source_system + source_event_id` 或 `event_id`）与去重策略。
  - 定义“纠错/回补”对下游的影响传播（指标回补、特征重算、预警更正提示）。
- **验收**：
  - 回放/倍速/跳转时，多源数据仍能保持逻辑一致，不出现“穿帮”。

### 2.3 数据质量（DQ）：从标签到评分与动作

- **补充内容**：
  - 质量标签升级为 **评分 + 原因码**：`dq_score` 与 `dq_reasons[]`。
  - 定义“质量动作”：低质量数据进入隔离/降权/触发人工核验；不同业务对 DQ 阈值不同。
  - 质量监控：缺失率、延迟分布、异常值比例、源系统稳定性等。
- **验收**：
  - 质量恶化时，模型 `confidence` 与智能体输出必须同步降级并说明原因。

### 2.4 血缘与可追溯：落到“可查询的证据包”

- **补充内容**：
  - 定义 `version_refs` 的统一结构（规则版本、模型版本、知识版本、注入策略版本）。
  - 关键输出（预警/任务/战报）必须能生成“证据包索引”：包含输入数据引用、版本引用、注入元信息。
- **验收**：
  - 抽样预警/任务可一键追溯到：原始载荷、转换版本、模型/规则/知识版本、注入策略（如有）。

---

## 3. 本体（V7 1.3）需要补齐的工程化能力

### 3.1 本体变更管理：版本、迁移、回滚

- **补充内容**：
  - 本体实体/关系/字段变化必须版本化（`ontology_version`），并定义迁移策略（新增/废弃/重命名/拆分）。
  - 变更影响分析：哪些查询、规则、模型、工作流会受影响。
- **验收**：
  - 本体升级不导致线上查询崩溃；兼容期内旧接口可用；必要时可回滚。

### 3.2 实体消歧与主数据匹配（MDM）工程

- **补充内容**：
  - 定义“匹配规则优先级”（确定性规则优先，模糊匹配需人工确认）。
  - 定义冲突处理（同一 source_object_id 映射多个 object_id 的处置流程）。
- **验收**：
  - MDM 命中率可观测；未命中形成待办闭环；冲突可追踪与可修复。

### 3.3 本体查询服务：性能与权限边界

- **补充内容**：
  - 典型查询模式标准化：对象详情、邻近关系、影响传播、责任链路展开。
  - 引入查询缓存与限流策略，避免在应急高峰压垮查询服务。
  - 权限：对象级/区域级过滤（跨区不可见或脱敏）。
- **验收**：
  - 关键查询满足响应时间目标（以 P95 为主），并可按区域/角色正确裁剪数据。

---

## 4. 模型与服务（V7 1.5/1.9.3）需要补齐的工程化闭环

### 4.1 特征口径的“线上/离线一致性”

- **补充内容**：
  - 明确特征定义文档（字段、窗口、口径、缺失处理）与版本（`feature_set_version`）。
  - 统一“缺失/低质量”处理：填充策略、降级策略、对置信度的影响规则。
- **验收**：
  - 同一时间段离线回测与线上推理结果差异可控，并可解释。

### 4.2 不确定性与置信度：从“一个数字”到“可审计来源”

- **补充内容**：
  - 置信度拆解来源：数据质量折减 + 模型不确定性 + 时效折减（短临越远越低）。
  - 输出中增加 `confidence_breakdown`（例如：dq=0.8，model=0.7，horizon=0.6）。
- **验收**：
  - 指挥端与战报能解释“为什么置信度变低”，并引导人工核验。

### 4.3 模型治理（ModelOps）：发布、回测、回滚与漂移

- **补充内容**：
  - 模型注册中心：模型版本、训练数据窗、指标、审批记录。
  - 回测基线：命中率、提前量、误报/漏报、空间偏差。
  - 漂移监控：特征分布漂移、输出分布漂移触发回测与降级。
- **验收**：
  - 每次模型升级必须通过回放+注入回归集；失败自动阻断发布并可回滚。

---

## 5. 智能体（V7 1.6/1.9.4）需要补齐的“可控工程化”

### 5.1 工具调用（Tool Calling）工程：幂等、鉴权、审计

- **补充内容**：
  - 每个工具定义：参数 Schema、返回 Schema、权限要求、幂等键、重试策略、审计字段。
  - 写操作必须可幂等（例如 `request_id`），避免多次派单。
- **验收**：
  - 任意一次智能体建议可追溯到：检索证据、工具调用、输出版本与审批链路。

### 5.2 输出结构（Schema）校验与降级策略

- **补充内容**：
  - 智能体输出必须进行 Schema 校验；不合格则自动重试/回退模板化输出。
  - 无证据不下结论：强制输出 `missing_inputs[]` 与“需人工核验项”。
- **验收**：
  - 结构化合规率可量化；证据覆盖率可量化；高风险动作 100% 进入人审。

### 5.3 安全与防护：提示词注入、越权与敏感信息

- **补充内容**：
  - 输入净化（外部文本/工单/附件）与提示词注入防护。
  - 权限继承：智能体只能在调用人权限范围内查询与派单。
  - 敏感信息脱敏：个人信息、精确定位、关键基础设施敏感字段按角色裁剪。
- **验收**：
  - 越权访问测试用例必须被拦截；敏感字段在低权限角色不可见。

---

## 6. 工作流与协同（V7 1.7/1.9.5）需要补齐的工程能力

### 6.1 状态机：补齐“重试/补偿/一致性”

- **补充内容**：
  - 状态迁移规则（允许/禁止迁移）、并发控制、幂等更新。
  - 外部通知/联动失败的补偿策略（重试、人工接管、回滚/撤销任务）。
- **验收**：
  - 网络抖动/重复提交/延迟回执不导致状态错乱；关键动作可追责。

### 6.2 SLA（服务水平协议/服务等级协议）落地

- **补充内容**：
  - SLA 需拆解：接单 SLA、到场 SLA、处置 SLA、证据完整 SLA。
  - 超时策略：催办→转派→升级上报，且必须在战报指标中体现。
- **验收**：
  - SLA 指标可统计、可告警、可复盘；超时链路可追溯。

### 6.3 证据链：从“附件上传”到“可审计证据包”

- **补充内容**：
  - 证据类型标准：定位/照片/视频/表单字段/第三方记录。
  - 证据校验与完整性：缺证据不可结案；证据有哈希与版本引用。
- **验收**：
  - 抽样任务可生成“证据包”并用于复盘与问责。

---

## 7. 可靠性、可观测与安全合规（V7 建议补成独立章节）

### 7.1 可观测三件套：日志、指标、链路追踪

- **补充内容**：
  - 指标：端到端时延、成功率、队列积压、模型推理耗时、智能体工具调用耗时、任务完成率、证据完备率。
  - 追踪：一个 incident_id 贯穿全链路（数据→预警→研判→派单→回执→战报）。
- **验收**：
  - 任一事件能从时间线定位到具体调用链与版本引用。

### 7.2 安全与合规：最小权限 + 审计闭环

- **补充内容**：
  - RBAC/ABAC 规则最小集合：按区域、对象类型、角色划分访问与操作权限。
  - 审计：关键操作（审批、封控建议、派单、撤销）必须留痕不可抵赖。
- **验收**：
  - 审计报表可导出；敏感操作可追责；权限变更有审批与留痕。

---

## 8. 回归测试与验收体系：把“能演示”变成“可持续迭代”

### 8.1 回放+注入驱动的回归集（必备）

- **补充内容**：
  - 固化若干典型演练脚本：雨强突增、泵站故障、道路封闭、倒灌顶托。
  - 每次规则/模型/知识/本体变更，必须跑回归集并输出差异报告（关键节点是否命中、指标是否达标）。
- **验收**：
  - 回归报告能证明：核心闭环节点稳定可复现，且关键指标不退化。

### 8.2 智能体评测：结构化合规与证据覆盖

- **补充内容**：
  - 结构化输出命中率、证据覆盖率、越权工具调用拦截率、高风险动作人审命中率。
- **验收**：
  - 评测指标达到阈值才能发布新版本。

---

## 9. 推荐补充到 V7 的“技术章节结构”（便于下一版合并）

- 新增一章：**平台治理与持续交付（Foundry/Gotham/Apollo 统一治理）**\n  - Schema Registry\n  - 版本体系（ontology/policy/model/knowledge/feature）\n  - 发布流程（审批/灰度/回滚/回测）\n  - 观测与审计（指标/追踪/报表）\n  - 回归验收（回放+注入）\n\n> 若你希望，我可以把本 V8 的内容进一步“落表+落接口”：给出最小必需表结构、关键 API 契约、幂等键设计、审计字段、以及一份可直接拆分的研发任务清单（按 Foundry/Gotham/Apollo 三条线拆）。\n*** End Patch"}]}]}环视图 likely; but avoid. Need fix JSON patch usage: apply_patch expects FREEFORM string not JSON. We'll call apply_patch properly.
