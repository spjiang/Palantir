# 应急安全AI操作系统方案书
## 系统架构总结（L0-L6）

---

## 目录

1. 系统整体架构
2. L0 界面层
3. L1 数据接入与治理
4. L2 语义与状态（本体）
5. L3 风险推理（模型）
6. L4 智能体决策
7. L5 执行闭环（工作流）
8. L6 战报与追溯
9. 数据流向与智能体决策详解
10. Token 消耗总结

---

## 系统整体架构（L0-L6）

### 七层架构体系

```
L0 界面层
  ↓
L1 数据接入与治理
  ↓
L2 语义与状态（本体）
  ↓
L3 风险推理（模型）
  ↓
L4 智能体决策
  ↓
L5 执行闭环（工作流）
  ↓
L6 战报与追溯
```

### 核心特点

- **分层设计**：职责清晰，层次分明
- **数据驱动**：从数据采集到决策执行全链路
- **AI 赋能**：大模型 + 传统 ML 模型协同
- **闭环反馈**：战报数据回馈知识库，形成飞轮效应

---

## L0 界面层

### 功能定位

- Vue3 前端界面
- 风险热力图展示
- 智能体对话交互
- 战报可视化展示

### 数据清单

- **TopN 风险数据**：实时展示 Top 12 风险点位
- **事件数据**：incident_id、事件标题、创建时间、状态
- **任务包数据**：TaskPack 结构
- **战报数据**：时间线事件、指标统计、状态追溯
- **数据量**：约 1-5KB/请求，实时刷新频率 5-30 秒

### AI 应用

- **智能对话**：暴雨参谋长智能体理解用户意图
- **任务包生成**：基于风险数据自动生成结构化任务包
- **一键派单**：自然语言指令转换为可执行任务包

### Token 消耗

- **单次对话**：约 500-2000 tokens
- **RAG 检索**：约 1000-3000 tokens
- **日均消耗**：约 15-50 万 tokens/天

---

## L1 数据接入与治理

### 功能定位

- Raw/ODS/TSDB 数据存储
- 数据质量检测
- 特征提取

### 数据清单

- **Raw 层**：原始传感器数据，约 10-100 万条/天
- **ODS 层**：清洗后的结构化数据，约 5-50 万条/天
- **TSDB 层**：时序数据库，约 1000 万条/月
- **数据源**：雨量站、雷达站、水位站、泵站、路况传感器，约 50-200 个

### 语义建模

```
数据源(雨量站-001) --采集--> Raw(rain_raw_001)
Raw(rain_raw_001) --清洗--> ODS(rain_ods_001)
ODS(rain_ods_001) --聚合--> TSDB(rain_tsdb_001)
TSDB(rain_tsdb_001) --特征提取--> 特征(feature_001)
```

### AI 应用

- **数据质量检测**：AI 识别异常数据、缺失值、异常值
- **自动数据清洗**：基于规则和模型的数据清洗策略
- **特征工程**：自动提取时间序列特征

### Token 消耗

- **数据质量检测**：少量 Token（主要用于规则配置）
- **特征工程**：无 Token 消耗（传统机器学习）

---

## L2 语义与状态（本体）

### 功能定位

- Neo4j/JanusGraph/RDF 知识图谱
- 实体关系管理
- 状态快照存储

### 数据清单

- **实体数据**：路段、泵站、区域、事件等，约 1000-5000 个
- **关系数据**：实体间关系，约 5000-20000 条
- **属性数据**：实体属性，约 10-50 个属性/实体
- **状态快照**：ObjectState 表，约 10 万条历史状态记录

### 知识图谱示例

```
区域(江北新区) --包含--> 路段(road-001)
路段(road-001) --关联--> 泵站(pump-station-001)
路段(road-001) --位于--> 位置(坐标:106.5,29.5)
路段(road-001) --责任单位--> 组织(区排水)
路段(road-001) --触发--> 事件(incident-001)
事件(incident-001) --风险等级--> 风险(红)
风险(红) --置信度--> 置信度(0.85)
```

### AI 应用

- **实体识别**：从文本中提取实体
- **关系抽取**：识别实体间关系
- **语义理解**：理解用户查询意图，转换为 SPARQL 查询
- **知识补全**：基于已有知识推理缺失关系

### Token 消耗

- **实体识别**：约 200-500 tokens/次
- **关系抽取**：约 300-800 tokens/次
- **SPARQL 生成**：约 500-1500 tokens/次
- **日均消耗**：约 5-15 万 tokens/天

---

## L3 风险推理（模型）

### 功能定位

- XGBoost/LightGBM/LSTM 模型
- 风险评分预测
- 置信度计算
- 解释因子生成

### 数据清单

- **特征数据**：时间序列特征，约 20-50 个特征/对象
- **训练数据**：历史风险事件标注数据，约 1-10 万条样本
- **推理数据**：实时特征数据，约 1000-5000 条/次推理
- **模型输出**：risk_score（0-10）、risk_level（红/橙/黄/绿）、confidence（0-1）、explain_factors

### 特征关系图

```
对象(road-001) --特征--> 特征(rain_now_mmph: 63)
对象(road-001) --特征--> 特征(water_level_mm: 450)
特征(rain_now_mmph) --影响--> 风险(risk_score: 8.5)
特征(water_level_mm) --影响--> 风险(risk_score: 8.5)
风险(risk_score: 8.5) --等级--> 风险等级(红)
风险(risk_score: 8.5) --置信度--> 置信度(0.85)
风险(risk_score: 8.5) --解释因子--> 因子(雨强上升, 水位超限)
```

### AI 应用

- **风险评分**：XGBoost/LightGBM/LSTM 模型预测
- **风险等级分类**：映射为红/橙/黄/绿等级
- **置信度计算**：基于特征完整性和模型不确定性
- **解释因子生成**：SHAP/LIME 解释模型决策

### Token 消耗

- **模型推理**：无 Token 消耗（传统机器学习模型）
- **解释生成**：少量 Token（约 100-300 tokens/次）

---

## L4 智能体决策

### 功能定位

- LLM + RAG + Function Calling
- 任务包编排
- 责任归属推理

### 数据清单

- **TopN 风险数据**：输入 TopN 风险点位
- **RAG 知识库**：预案/规程/历史战报文档，约 100-1000 篇，向量化后约 10-100 万向量
- **任务包数据**：输出 TaskPack（tasks[]、owner_org、SLA、required_evidence、need_approval）
- **对话历史**：用户对话记录，约 1000-10000 条/月

### 任务包关系图

```
风险对象(road-001) --触发--> 智能体决策
智能体决策 --检索--> RAG知识库(预案-001)
RAG知识库(预案-001) --引用--> 知识片段(封控流程)
智能体决策 --生成--> 任务包(task-pack-001)
任务包(task-pack-001) --包含--> 任务(task-001: 封控准备)
任务(task-001) --责任单位--> 组织(交警)
任务(task-001) --SLA--> 时限(20分钟)
```

### AI 应用

- **意图理解**：理解用户自然语言请求
- **RAG 检索**：向量检索相关预案/规程/历史战报
- **任务包编排**：生成结构化任务包
- **责任归属推理**：根据对象类型、风险等级推理责任单位
- **SLA 计算**：根据风险等级、任务类型计算合理的 SLA 时限

### Token 消耗（主要消耗）

- **单次对话**：约 2000-5000 tokens
- **RAG 检索**：约 2000-5000 tokens（上下文）
- **工具调用**：约 500-1000 tokens
- **日均消耗**：约 45-110 万 tokens/天
- **月均消耗**：约 1350-3300 万 tokens/月

---

## L5 执行闭环（工作流）

### 功能定位

- Camunda/Zeebe/Conductor 工作流引擎
- 任务分派
- 状态跟踪
- 审批流程

### 数据清单

- **任务包数据**：接收的 TaskPack，约 100-1000 个/天
- **任务数据**：任务列表（tasks[]），约 500-5000 个任务/天
- **状态数据**：任务状态变更记录，约 2000-20000 条/天
- **证据数据**：上传的附件，约 1000-10000 个文件/天
- **审批数据**：审批记录，约 100-1000 条/天

### 工作流关系图

```
任务包(task-pack-001) --包含--> 任务(task-001)
任务(task-001) --分派--> 责任单位(交警)
任务(task-001) --状态流转--> 状态(待处理 → 进行中 → 已完成)
任务(task-001) --收集--> 证据(定位, 照片)
任务(task-001) --触发--> 审批(approval-001)
审批(approval-001) --审批人--> 人员(部门主管)
审批(approval-001) --结果--> 状态(已通过)
```

### AI 应用

- **智能分派**：根据任务类型、地理位置、负载均衡智能分派
- **超时预测**：基于历史数据预测任务可能超时
- **证据校验**：AI 识别证据完整性、格式正确性
- **审批路由**：根据任务风险等级智能路由审批流程

### Token 消耗

- **智能分派**：约 500-1000 tokens/次
- **证据校验**：约 200-500 tokens/次
- **日均消耗**：约 7-15 万 tokens/天

---

## L6 战报与追溯

### 功能定位

- TimelineEvent/ObjectState 时间线构建
- 指标计算
- 报告生成

### 数据清单

- **TimelineEvent**：事件时间线记录，约 10000-100000 条/月
- **ObjectState**：对象状态快照，约 100000-1000000 条/月
- **指标数据**：任务完成率、SLA 达成率、响应时间、处置时长，实时计算
- **报告数据**：生成的战报（JSON/HTML/PDF），约 100-1000 份/月

### 时间线关系图

```
事件(incident-001) --时间线--> TimelineEvent(tl-001: 事件创建)
TimelineEvent(tl-001) --触发--> TimelineEvent(tl-002: 告警)
TimelineEvent(tl-002) --关联--> 对象(road-001)
对象(road-001) --状态变更--> ObjectState(state-001: 风险等级 黄→红)
ObjectState(state-001) --触发事件--> TimelineEvent(tl-003: 状态变更)
TimelineEvent(tl-003) --关联--> 任务包(task-pack-001)
任务包(task-pack-001) --完成--> TimelineEvent(tl-004: 任务完成)
```

### AI 应用

- **事件聚合**：智能识别相关事件，按 incident_id 聚合
- **时间线生成**：AI 识别关键里程碑，生成时间线视图
- **报告生成**：基于模板和数据结构，生成结构化战报
- **自然语言总结**：LLM 生成事件摘要、处置总结
- **智能检索**：基于自然语言的战报检索、事件追溯

### Token 消耗

- **报告生成**：约 1000-3000 tokens/次
- **自然语言总结**：约 500-2000 tokens/次
- **智能检索**：约 500-1500 tokens/次
- **日均消耗**：约 20-65 万 tokens/天

---

## 数据流向

### 正向流程

```
数据采集 → L1 数据治理 → L2 语义建模 → L3 风险推理
```

### 决策流程

```
L3 风险评分 → L4 智能体决策 → L5 工作流执行 → L6 战报生成
```

### 反馈流程

```
L6 战报数据 ↗ L4 RAG 知识库 ↗ L0 界面展示
```

---

## L4 智能体决策：数据输入与输出详解

### 1. 研判输入数据（从 L3 风险推理层传入）

**TopN 风险数据（JSON 数组）**

```json
[
  {
    "target_id": "a-001-road-001",
    "area_id": "A-001",
    "risk_score": 8.5,
    "risk_level": "红",
    "confidence": 0.85,
    "explain_factors": ["雨强上升", "水位超限", "历史事件"],
    "object_type": "road_segment",
    "features": {
      "rain_now_mmph": 63,
      "rain_1h_mm": 120,
      "water_level_mm": 450
    },
    "attrs": {
      "name": "路段1",
      "admin_area": "江北新区",
      "location": "106.5,29.5"
    }
  }
]
```

### 2. 传入大模型的数据结构（LLM Prompt）

**系统提示词 + 用户消息 + RAG 检索结果**

- **System Prompt**：角色设定、任务说明、输出格式要求
- **User Message**：用户请求 + TopN 风险数据
- **RAG 检索结果**：相关预案/规程/历史战报

**总 Token 数**：约 2000-5000 tokens

### 3. 任务包下发输出数据（TaskPack JSON）

```json
{
  "incident_id": "inc-1766020476806",
  "title": "江北新区 暴雨内涝处置事件",
  "created_at": "2025-12-18T01:14:36Z",
  "status": "pending",
  "tasks": [
    {
      "task_id": "task-001",
      "task_type": "封控准备",
      "target_object_id": "a-001-road-001",
      "description": "对路段1进行封控准备，设置警示标志，疏导交通",
      "owner_org": "交警",
      "sla_minutes": 20,
      "required_evidence": ["定位", "照片", "视频"],
      "need_approval": true,
      "approval_flow": "高风险任务审批",
      "priority": "high",
      "estimated_duration": 15
    }
  ],
  "metadata": {
    "rag_sources": ["应急预案-封控流程", "历史战报-2024-07-15"],
    "reasoning": "基于风险等级'红'、雨强63mm/h、水位450mm，参考历史战报，生成封控和泵站启动任务",
    "confidence": 0.88
  }
}
```

**输出 Token 数**：约 500-2000 tokens

### 4. 数据流转过程

1. L3 风险推理层输出 TopN 风险数据
2. L4 智能体接收 TopN 数据，用户发起研判请求
3. L4 RAG 检索：基于风险数据检索相关预案/规程/历史战报
4. L4 构建 LLM Prompt：系统提示词 + 用户消息 + RAG 检索结果
5. L4 调用 LLM（Function Calling）：输入 Prompt，输出结构化 TaskPack JSON
6. L4 输出 TaskPack：包含 tasks[]、owner_org、SLA、required_evidence、need_approval
7. L5 工作流层接收 TaskPack，解析任务列表，启动任务分派和状态跟踪

---

## 核心字段说明

### 风险评分相关字段

- **risk_score（风险分数）**：0-10，表示对象的综合风险评分
- **risk_level（风险等级）**：红/橙/黄/绿四个等级
- **confidence（置信度）**：0-1，表示模型对风险评分的置信程度
- **explain_factors（解释因子）**：字符串数组，列出导致风险评分的主要因素

### 任务包相关字段

- **TaskPack（任务包）**：结构化任务包对象
- **tasks[]（任务列表）**：任务数组
- **owner_org（责任单位）**：负责执行任务的组织单位
- **SLA（服务级别协议/时限）**：任务完成的时间限制（分钟）
- **required_evidence（必传证据）**：完成任务必须提交的证据类型列表
- **need_approval（需审批）**：布尔值，表示任务是否需要审批

---

## Token 消耗总结

### 各层次 Token 消耗

| 层次 | 日均消耗 | 说明 |
|------|---------|------|
| L0 界面层 | 15-50 万 tokens/天 | 智能对话、RAG 检索 |
| L1 数据接入与治理 | 0-1 万 tokens/天 | 少量（规则配置） |
| L2 语义与状态 | 5-15 万 tokens/天 | 实体识别、关系抽取、SPARQL 生成 |
| L3 风险推理 | 0-1 万 tokens/天 | 少量（解释生成） |
| L4 智能体决策 | **45-110 万 tokens/天** | **主要消耗** |
| L5 执行闭环 | 7-15 万 tokens/天 | 智能分派、证据校验 |
| L6 战报与追溯 | 20-65 万 tokens/天 | 报告生成、自然语言总结 |

### 系统总计

- **日均消耗**：约 **92-257 万 tokens/天**
- **月均消耗**：约 **2760-7710 万 tokens/月**

---

## AI 带来的飞轮效应

### L0 界面层

- 用户使用智能体 → 系统记录对话数据 → 优化提示词 → 提升准确率
- 每次任务执行产生数据 → 丰富训练样本 → 提升模型效果
- 历史战报积累 → RAG 知识库扩充 → 智能体建议更准确

### L1 数据接入与治理

- AI 检测异常 → 人工修正 → 模型学习 → 检测更准确
- 特征使用反馈 → 优化特征工程 → 提升模型效果

### L2 语义与状态

- AI 抽取实体关系 → 人工审核 → 图谱扩充 → 抽取更准确
- 用户查询 → AI 理解意图 → 优化查询 → 结果更精准

### L3 风险推理

- 预测结果 → 实际事件验证 → 模型重训练 → 预测更准确
- 模型解释 → 发现重要特征 → 特征优化 → 模型提升
- 每次事件产生标注数据 → 训练集扩充 → 模型效果提升

### L4 智能体决策

- 每次任务执行产生战报 → 知识库扩充 → RAG 检索更准确 → 任务包质量提升
- 任务包执行反馈 → 优化提示词 → 生成更准确 → 执行成功率提升
- 任务执行结果 → 验证责任单位正确性 → 优化推理规则 → 准确率提升
- 用户对话数据 → 微调模型 → 理解更准确 → 用户体验提升

### L5 执行闭环

- 任务执行结果 → 验证分派合理性 → 优化分派策略 → 效率提升
- 实际超时数据 → 训练预测模型 → 预测更准确 → 提前干预
- 流程执行数据 → 识别瓶颈 → 优化流程 → 效率提升

### L6 战报与追溯

- 用户反馈 → 优化报告模板 → 报告更清晰 → 用户满意度提升
- 历史战报积累 → 知识库扩充 → RAG 检索更准确 → 智能体建议更准确
- 追溯查询数据 → 优化索引 → 查询更快 → 用户体验提升

---

## 总结

### 系统核心价值

1. **分层架构**：L0-L6 七层架构，职责清晰，易于扩展
2. **数据驱动**：从数据采集到决策执行全链路打通
3. **AI 赋能**：大模型 + 传统 ML 模型协同，智能决策
4. **闭环反馈**：战报数据回馈知识库，形成飞轮效应

### 技术亮点

- **RAG 检索增强**：结合预案/规程/历史战报，生成有依据的建议
- **Function Calling**：结构化输出，确保任务包格式规范
- **可解释性**：SHAP/LIME 解释模型决策，提升可信度
- **工作流引擎**：任务分派、状态跟踪、审批流程自动化

### 应用场景

- 暴雨内涝应急处置
- 风险点位实时监测
- 智能任务包生成与派发
- 事件追溯与战报生成

---

## 谢谢！

**应急安全AI操作系统方案书**
**系统架构总结（L0-L6）**
