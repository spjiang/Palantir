# 部署文档（演示级）：城市暴雨内涝指挥一键闭环

本部署文档适用于 `demo-os/` 目录下的演示级系统，一键拉起以下组件：

- 前端：Vue3（`frontend`）
- 后端：Python/FastAPI（`api`）
- 智能体：LangChain（`agent`，可选接入 DeepSeek）
- 小模型：开源 scikit-learn（`model-service`）
- 基础设施：PostgreSQL、Redis

> 说明：这是“演示级”部署，目标是跑通闭环与关键接口；不包含生产级高可用、灰度、容灾等。

---

## 1. 目录与文件

项目路径：

- `demo-os/docker-compose.yaml`：docker-compose 编排文件（演示级）
- `demo-os/README.md`：快速启动说明

---

## 2. 环境准备（前置条件）

### 2.1 服务器/本机要求（建议）

- **CPU**：4 核以上（建议 8 核）
- **内存**：8GB 以上（建议 16GB）
- **磁盘**：10GB 以上可用空间（镜像/依赖/数据卷）
- **网络**：首次 `docker-compose up --build` 需要访问镜像仓库与拉取依赖

### 2.2 软件要求

- **Docker Desktop / Docker Engine**：版本建议 >= 24
- **docker-compose**：支持 `docker-compose` 命令

验证：

```bash
docker --version
docker-compose version
```

---

## 3. 配置说明（含 DeepSeek）

### 3.1 默认端口

| 服务 | 容器名 | 端口 | 说明 |
|---|---|---:|---|
| 前端 | `frontend` | 7080 | 访问入口 |
| 后端 API | `api` | 7000 | Swagger：`/docs` |
| 智能体服务 | `agent` | 7001 | Swagger：`/docs` |
| 小模型服务 | `model-service` | 7002 | Swagger：`/docs` |
| PostgreSQL | `postgres` | 7432 | 演示业务库 |
| Redis | `redis` | 7379 | 缓存/队列 |

> 如端口冲突，请修改 `docker-compose.yaml` 对应 `ports:` 映射。

### 3.2 DeepSeek（可选）

系统支持两种模式：

- **无 DeepSeek Key**：智能体自动使用“规则式策略”生成任务包，确保演示稳定可跑通。
- **有 DeepSeek Key**：智能体会调用 DeepSeek 生成更自然的研判摘要（结构化任务仍由程序控制，避免不可控）。

配置方式（推荐用环境变量）：

```bash
export DEEPSEEK_API_KEY="你的Key"
export DEEPSEEK_BASE_URL="https://api.deepseek.com"
export DEEPSEEK_MODEL="deepseek-chat"
```

---

## 4. 一键部署与启动

进入目录：

```bash
cd /Users/jiangshengping/wwwroot/rtzh/wwwroot/Palantir/demo-os
```

启动（首次会 build 镜像）：

```bash
docker-compose up --build
```

后台启动：

```bash
docker-compose up --build -d
```

查看运行状态：

```bash
docker-compose ps
docker-compose logs -f --tail=200
```

---

## 5. 验证与演示流程（跑通闭环）

### 5.1 打开前端

浏览器访问：

- `http://localhost:7080`

### 5.2 验证后端/智能体/小模型

- 后端：`http://localhost:7000/docs`
- 智能体：`http://localhost:7001/docs`
- 小模型：`http://localhost:7002/docs`

### 5.3 典型闭环操作（与方案对齐）

1) **风险 TopN**：前端点击“刷新 TopN”  
2) **智能体研判**：输入“请研判并一键下发任务包”，点击“发送”  
3) **任务列表**：点击“加载任务”查看派单结果  
4) **回执**：点击“一键回执完成”  
5) **战报**：点击“生成战报”

---

## 6. 停止、重启与清理

停止：

```bash
docker-compose down
```

停止并清理数据卷（会删除 PostgreSQL 数据，谨慎执行）：

```bash
docker-compose down -v
```

仅重启某个服务（例如后端）：

```bash
docker-compose restart api
```

---

## 7. 数据持久化与初始化

- PostgreSQL 使用数据卷 `pgdata` 持久化（见 `docker-compose.yaml`）。
- 后端容器默认开启 `AUTO_SEED=true`：首次启动会自动写入演示对象与默认事件（便于开箱即用）。

---

## 8. 常见问题排查

### 8.1 端口占用

现象：启动失败提示端口被占用。  
处理：修改 `docker-compose.yaml` 的端口映射，或停止占用端口的程序。

### 8.2 构建失败（依赖下载失败）

现象：`docker-compose up --build` 在安装 Python/NPM 依赖时失败。  
处理：检查网络/代理；必要时配置镜像源；然后重试：

```bash
docker-compose build --no-cache
docker-compose up
```

### 8.3 智能体服务不调用 DeepSeek

现象：`agent` 的 `/health` 显示 `deepseek_enabled=false`。  
处理：确认 `DEEPSEEK_API_KEY` 已导出并在同一 shell 中执行了 `docker-compose up`；或使用 `.env` 文件（自行创建）：

```bash
DEEPSEEK_API_KEY=xxxx
DEEPSEEK_BASE_URL=https://api.deepseek.com
DEEPSEEK_MODEL=deepseek-chat
```

然后：

```bash
docker-compose up -d --build
```

### 8.4 数据库报错/脏状态

处理：演示级建议直接清卷重置：

```bash
docker-compose down -v
docker-compose up --build
```


